#!/usr/bin/env ruby
# frozen_string_literal: true

require "bundler/setup"

require "json"
require "ostruct"
require "optparse"
require "bigrivercalc"

# Stub mode: use fixture data for sanity check without AWS
def stub_response
  fixture_path = File.expand_path("../spec/fixtures/sample_response.json", __dir__)
  json = JSON.parse(File.read(fixture_path))
  OpenStruct.new(
    results_by_time: json["ResultsByTime"].map { |rbt|
      OpenStruct.new(
        time_period: OpenStruct.new(start: rbt["TimePeriod"]["Start"], end: rbt["TimePeriod"]["End"]),
        total: rbt["Total"],
        groups: (rbt["Groups"] || []).map { |g|
          OpenStruct.new(
            keys: g["Keys"],
            metrics: (g["Metrics"] || {}).transform_values { |m| OpenStruct.new(amount: m["Amount"], unit: m["Unit"]) }
          )
        },
        estimated: rbt["Estimated"]
      )
    }
  )
end

def parse_args
  options = { format: "markdown", stub: false, account: nil, ou: nil, all_ous: false, period: nil }
  parser = OptionParser.new do |opts|
    opts.banner = "Usage: bigrivercalc [options]"
    opts.on("-f", "--format FORMAT", "Output format: markdown or terminal") { |v| options[:format] = v }
    opts.on("--stub", "Use fixture data (no AWS call)") { options[:stub] = true }
    opts.on("-a", "--account ID", "Filter by AWS account ID") { |v| options[:account] = v }
    opts.on("--ou OU_ID", "Filter by AWS Organizations OU") { |v| options[:ou] = v }
    opts.on("--all-ous", "Show billing for each OU under the root") { options[:all_ous] = true }
    opts.on("-p", "--period PERIOD", "Time period: YYYY-MM, current, last-month") { |v| options[:period] = v }
    opts.on("-h", "--help", "Show this help") do
      puts opts
      exit 0
    end
  end
  parser.parse!
  options
end

def run
  options = parse_args
  format_type = options[:format]
  stub = options[:stub]

  time_period = Bigrivercalc::PeriodParser.parse(options[:period]) if options[:period]

  if options[:all_ous] && (options[:account] || options[:ou])
    $stderr.puts "Error: --all-ous cannot be combined with --account or --ou"
    exit 1
  end

  if options[:all_ous] && stub
    $stderr.puts "Error: --all-ous is not supported with --stub"
    exit 1
  end

  if options[:all_ous]
    ou_results = Bigrivercalc.fetch_billing_by_ou(time_period: time_period)
    period_label = time_period ? "#{time_period[:start]} to #{time_period[:end]}" : nil

    output = case format_type
    when "terminal"
      Bigrivercalc.format_terminal_by_ou(ou_results, period: period_label)
    else
      Bigrivercalc.format_markdown_by_ou(ou_results, period: period_label)
    end
  else
    line_items = if stub
      Bigrivercalc::BillingParser.new.parse(stub_response)
    else
      Bigrivercalc.fetch_billing(time_period: time_period, account_id: options[:account], ou_id: options[:ou])
    end

    if line_items.empty?
      $stderr.puts "No billing data found for the specified period."
      exit 1
    end

    period_label = line_items.first&.period || (time_period ? "#{time_period[:start]} to #{time_period[:end]}" : nil)
    formatter_opts = { account_id: options[:account], period: period_label }

    output = case format_type
    when "terminal"
      Bigrivercalc.format_terminal(line_items, **formatter_opts)
    else
      Bigrivercalc.format_markdown(line_items, **formatter_opts)
    end
  end

  puts output
  exit 0
rescue Aws::Errors::MissingCredentialsError
  $stderr.puts "Error: AWS credentials not found. Set AWS_ACCESS_KEY_ID/AWS_SECRET_ACCESS_KEY or run `aws configure`."
  exit 1
rescue Aws::Errors::ServiceError => e
  $stderr.puts "Error: #{e.message}"
  exit 1
rescue Bigrivercalc::Error => e
  $stderr.puts "Error: #{e.message}"
  exit 1
rescue OptionParser::InvalidOption, OptionParser::MissingArgument => e
  $stderr.puts "Error: #{e.message}"
  exit 1
end

run
